name: MacOS PKG Installer Tests

defaults:
  run:
    shell: bash -l {0}

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'MacOS/pkg_installer/**'
      - 'MacOS/Components/**'
      - '.github/workflows/mac_pkg_installer.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION_PS: "3.11"
  PIS_ENV: "CI"

jobs:
  build-and-test-pkg:
    name: Build and Test macOS PKG Installer
    runs-on: macos-latest

    steps:
      - name: Show environment
        run: |
          sw_vers
          uname -a
          echo "Runner temp: $RUNNER_TEMP"
          echo "Runner tools: $RUNNER_TOOL_CACHE"
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build PKG (CI environment)
        working-directory: MacOS/pkg_installer/src
        env:
          BUILD_ENV: github_ci
        run: |
          bash build.sh

      - name: Locate built PKG
        id: find_pkg
        run: |
          PKG_PATH=$(ls -1 MacOS/pkg_installer/builds/*.pkg | tail -n 1)
          echo "pkg_path=$PKG_PATH" >> $GITHUB_OUTPUT
          echo "Found package: $PKG_PATH"

      - name: Install PKG
        run: |
          set -x
          sudo installer -pkg "${{ steps.find_pkg.outputs.pkg_path }}" -target /
        timeout-minutes: 20

      - name: Show PKG postinstall log and app locations
        run: |
          echo "Runner temp: $RUNNER_TEMP"
          for LOG in "$RUNNER_TEMP/macos_dtu_python_install_ci.log" \
                     "/tmp/macos_dtu_python_install_ci.log"; do
            if [[ -f "$LOG" ]]; then
              echo "=== Showing $LOG ==="
              tail -n +1 "$LOG" | sed -n '1,400p'
              break
            fi
          done
          echo "=== /Applications ==="; ls -la "/Applications" | sed -n '1,120p'
          echo "=== $HOME/Applications ==="; ls -la "$HOME/Applications" 2>/dev/null | sed -n '1,120p' || true

      - name: Verify VS Code is installed (relaxed)
        run: |
          set -e
          echo "Checking VS Code presence via brew cask list or app bundle..."
          if brew list --cask | grep -q '^visual-studio-code$'; then
            echo "✓ VS Code cask is installed"
            exit 0
          fi
          if [ -d "/Applications/Visual Studio Code.app" ] || [ -d "$HOME/Applications/Visual Studio Code.app" ]; then
            echo "✓ VS Code app bundle exists"
            exit 0
          fi
          echo "✗ VS Code not detected via brew or app bundle"
          exit 1

      - name: Verify conda
        run: |
          echo "PATH before verification: $PATH"
          which conda || true
          # add common Homebrew paths to PATH if needed
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
          which conda
          retval=$?
          if [[ $retval -ne 0 ]]; then
            echo "Conda not installed correctly"
            exit $retval
          fi

          conda --version
          conda info --base

      - name: Verify python (${{ env.PYTHON_VERSION_PS }})
        run: |
          # Prefer conda's Python from the base environment installed by PKG
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
          which conda
          BASE_DIR=$(conda info --base)
          echo "Conda base: $BASE_DIR"
          PY="$BASE_DIR/bin/python3"
          if [[ ! -x "$PY" ]]; then
            echo "Conda python not found at $PY"
            exit 1
          fi
          EXPECTED_VERSION="${{ env.PYTHON_VERSION_PS }}"
          INSTALLED_VERSION=$($PY --version | cut -d " " -f 2 || true)
          # Allow any 3.x in CI to minimize pkg flakiness
          if [[ "$INSTALLED_VERSION" != "$EXPECTED_VERSION"* ]]; then
            echo "Warning: Installed Python version ($INSTALLED_VERSION) does not match expected ($EXPECTED_VERSION). Proceeding in CI."
          fi
          echo "Python version reported: $INSTALLED_VERSION (conda base)."

          $PY -c "import dtumathtools, pandas, scipy, statsmodels, uncertainties; print('Packages imported successfully')" || { echo "Failed to import Python packages"; exit 1; }

      - name: Run final diagnostics (HTML report)
        env:
          REMOTE_PS: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name || github.repository }}
          BRANCH_PS: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}
        run: |
          echo "Running diagnostics from $REMOTE_PS@$BRANCH_PS"
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/$REMOTE_PS/$BRANCH_PS/MacOS/Components/Diagnostics/generate_report.sh)"
