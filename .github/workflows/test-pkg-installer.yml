name: Test PKG Installer

defaults:
  run:
    shell: bash -l {0}

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        required: false
        default: 'macos-components'
      clean_install:
        description: 'Clean install (remove existing components first)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  pull_request:
    paths:
      - 'MacOS/pkg_installer/**'
      - 'MacOS/Components/**'
      - '.github/workflows/test-pkg-installer.yml'

env:
  PYTHON_VERSION_PS: "3.11"
  PIS_ENV: CI

jobs:
  test-pkg-installer:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.head_ref || 'macos-components' }}

      - name: System Information
        run: |
          echo "=== System Information ==="
          sw_vers
          echo ""
          echo "=== Available Space ==="
          df -h /
          echo ""
          echo "=== Pre-test Environment ==="
          command -v brew >/dev/null 2>&1 && echo "‚úì Homebrew: $(brew --version | head -1)" || echo "‚úó Homebrew: Not installed"
          command -v conda >/dev/null 2>&1 && echo "‚úì Conda: $(conda --version)" || echo "‚úó Conda: Not installed"  
          command -v code >/dev/null 2>&1 && echo "‚úì VSCode: $(code --version | head -1)" || echo "‚úó VSCode: Not installed"
          [ -d "/Applications/Visual Studio Code.app" ] && echo "‚úì VSCode app found at /Applications" || echo "‚úó VSCode app not found"

      - name: Clean Install (Optional)
        if: inputs.clean_install == 'true'
        run: |
          echo "=== Performing Clean Install ==="
          # Remove Homebrew
          if command -v brew >/dev/null 2>&1; then
            echo "Removing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)" <<< $'y\ny\ny\ny\ny' || true
          fi
          
          # Remove Conda/Miniconda
          if [ -d "$HOME/miniconda3" ]; then
            echo "Removing Miniconda..."
            rm -rf "$HOME/miniconda3" || true
          fi
          if [ -d "$HOME/anaconda3" ]; then
            echo "Removing Anaconda..."
            rm -rf "$HOME/anaconda3" || true
          fi
          
          # Remove VSCode
          if [ -d "/Applications/Visual Studio Code.app" ]; then
            echo "Removing Visual Studio Code..."
            sudo rm -rf "/Applications/Visual Studio Code.app" || true
            rm -f /usr/local/bin/code || true
          fi
          
          # Clean shell profiles
          echo "Cleaning shell profiles..."
          sed -i '' '/brew shellenv/d' ~/.zprofile ~/.bash_profile 2>/dev/null || true
          sed -i '' '/conda initialize/,/conda initialize/d' ~/.zprofile ~/.bash_profile 2>/dev/null || true
          
          echo "Clean install preparation complete!"

      - name: Test Pre-built PKG
        working-directory: MacOS/pkg_installer
        run: |
          echo "=== Testing Pre-built PKG ==="
          
          # List available PKG files for testing
          echo "Available PKG files:"
          ls -la builds_for_testing/
          
          # Get the PKG file to test (currently the dummy PKG)
          PKG_FILE="builds_for_testing/DTU-Python-FirstYear-v1.0.0-dummy.pkg"
          
          if [[ ! -f "$PKG_FILE" ]]; then
            echo "‚ùå PKG file not found: $PKG_FILE"
            echo "Available files in builds_for_testing/:"
            ls -la builds_for_testing/ || echo "Directory not found"
            exit 1
          fi
          
          echo "PKG_FILE=$PKG_FILE" >> $GITHUB_ENV
          echo "üì¶ Testing PKG file: $PKG_FILE"
          
          echo "=== Package Information ==="
          installer -pkginfo -pkg "$PKG_FILE"

      - name: Install PKG
        working-directory: MacOS/pkg_installer
        run: |
          echo "=== Installing PKG ==="
          echo "Installing: $PKG_FILE"
          
          # Get absolute path for the PKG file
          PKG_ABSOLUTE_PATH="$(pwd)/$PKG_FILE"
          echo "Absolute path: $PKG_ABSOLUTE_PATH"
          
          # Verify PKG file exists
          if [[ ! -f "$PKG_ABSOLUTE_PATH" ]]; then
            echo "‚ùå PKG file not found at: $PKG_ABSOLUTE_PATH"
            ls -la "$(dirname "$PKG_ABSOLUTE_PATH")"
            exit 1
          fi
          
          # Install with verbose logging
          sudo installer -verbose -pkg "$PKG_ABSOLUTE_PATH" -target / 2>&1 | tee installation.log
          
          echo ""
          echo "=== Installation Log Summary ==="
          # Show key progress indicators from the log
          grep -E "(DTU Python Installer:|ERROR|WARNING|‚úì|‚ùå|üöÄ|‚è≠Ô∏è)" installation.log || echo "No progress indicators found"

      - name: Show Debug Logs
        run: |
          echo "=== Debug Logs from PKG Installation ==="
          if [[ -f "/tmp/macos_dtu_python_install.log" ]]; then
            echo "üìã Found installation log at /tmp/macos_dtu_python_install.log"
            echo ""
            echo "=== Last 100 lines of installation log ==="
            tail -100 /tmp/macos_dtu_python_install.log
          else
            echo "‚ùå Installation log not found at /tmp/macos_dtu_python_install.log"
            echo "Available files in /tmp:"
            ls -la /tmp/macos_* 2>/dev/null || echo "No macos_* files in /tmp"
          fi

      - name: Verify Dummy PKG Installation
        run: |
          echo "=== Dummy PKG Installation Verification ==="
          
          # Check that PKG files were installed correctly
          echo "Checking installed files..."
          if [ -f "/usr/local/share/dtu-pythonsupport/install.sh" ]; then
            echo "‚úì Main installer script found"
          else
            echo "‚ùå Main installer script not found"
            exit 1
          fi
          
          if [ -f "/usr/local/share/dtu-pythonsupport/.pkg_status" ]; then
            echo "‚úì PKG status file found"
            echo "Status file contents:"
            cat "/usr/local/share/dtu-pythonsupport/.pkg_status"
          else
            echo "‚ùå PKG status file not found"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Dummy PKG verification complete"

      # Note: VS Code, Conda, Python verification steps are disabled for dummy PKG
      # These will be re-enabled as components are added incrementally
      
      - name: Test Basic Functionality (Dummy PKG)
        run: |
          echo "=== Testing Dummy PKG Basic Functionality ==="
          
          # Test that the installer script can run
          if [ -x "/usr/local/share/dtu-pythonsupport/install.sh" ]; then
            echo "Testing installer script execution..."
            /usr/local/share/dtu-pythonsupport/install.sh
            echo "‚úÖ Installer script executed successfully"
          else
            echo "‚ùå Installer script not executable"
            exit 1
          fi

      - name: Upload Installation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-logs-${{ runner.os }}-${{ github.run_id }}
          path: |
            installation.log
            /tmp/macos_dtu_python_install.log
            /tmp/diagnostic_report_*.html
          retention-days: 7

      - name: Show Dummy PKG Installation Summary  
        if: always()
        run: |
          echo "=== Dummy PKG Installation Summary ==="
          echo "PKG File: $PKG_FILE"
          echo "Test Date: $(date)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo ""
          
          # Simple status check for dummy PKG
          PKG_INSTALLED=$([ -f "/usr/local/share/dtu-pythonsupport/.pkg_status" ] && echo "‚úì" || echo "‚ùå")
          INSTALLER_SCRIPT=$([ -x "/usr/local/share/dtu-pythonsupport/install.sh" ] && echo "‚úì" || echo "‚ùå")
          
          echo "Dummy PKG Status:"
          echo "  PKG Files Installed: $PKG_INSTALLED"
          echo "  Installer Script Executable: $INSTALLER_SCRIPT"
          
          # Determine overall success for dummy PKG
          if [[ "$PKG_INSTALLED$INSTALLER_SCRIPT" == "‚úì‚úì" ]]; then
            echo ""
            echo "üéâ Dummy PKG Installation Test: SUCCESS"
            echo "Phase 1 - Basic PKG functionality verified!"
            echo "Ready to add components incrementally."
            exit 0
          else
            echo ""
            echo "‚ùå Dummy PKG Installation Test: FAILED"
            echo "Basic PKG functionality not working."
            exit 1
          fi