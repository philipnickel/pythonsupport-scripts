#!/bin/bash
# DTU Python Environment PKG - Postinstall Script
set -e

echo "=== DTU Python Environment PKG Installation ==="
logger -t "DTU-Python-PKG" "Starting installation as root"

# Detect the logged-in user (important because installer runs as root)
current_user=$(stat -f "%Su" /dev/console)
user_home=$(eval echo "~$current_user")

echo "Installing for user: $current_user"
echo "User home: $user_home"

# Install Homebrew if missing
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c \
      "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Ensure brew is on PATH
eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)" || true

# Install VS Code and Miniconda as the user
echo "Installing VS Code..."
sudo -u "$current_user" brew install --cask visual-studio-code

echo "Installing Miniconda..."
sudo -u "$current_user" brew install miniconda

# Detect user's shell
user_shell=$(dscl . -read /Users/$current_user UserShell | awk '{print $2}')
shell_name=$(basename "$user_shell")

echo "User shell: $user_shell ($shell_name)"

# Determine shell rc file
case "$user_shell" in
  */zsh) shell_rc="$user_home/.zshrc" ;;
  */bash) shell_rc="$user_home/.bash_profile" ;;
  *) shell_rc="$user_home/.profile" ;;
esac

echo "Shell config file: $shell_rc"

# Initialize conda for this user
echo "Initializing conda for user $current_user..."
# Try both Apple Silicon and Intel paths
if [[ -x "/opt/homebrew/Caskroom/miniconda/latest/bin/conda" ]]; then
    conda_path="/opt/homebrew/Caskroom/miniconda/latest/bin/conda"
elif [[ -x "/usr/local/Caskroom/miniconda/latest/bin/conda" ]]; then
    conda_path="/usr/local/Caskroom/miniconda/latest/bin/conda"
else
    echo "ERROR: Could not find conda binary"
    exit 1
fi

echo "Using conda at: $conda_path"
sudo -u "$current_user" "$conda_path" init "$shell_name"

# Install Python packages
echo "Installing Python packages..."
sudo -u "$current_user" "$conda_path" install -y python=3.11
sudo -u "$current_user" "$conda_path" install -y pandas scipy statsmodels
sudo -u "$current_user" "$conda_path" install -y -c conda-forge uncertainties
sudo -u "$current_user" /opt/homebrew/bin/pip install dtumathtools || sudo -u "$current_user" /usr/local/bin/pip install dtumathtools

logger -t "DTU-Python-PKG" "Installation completed successfully"
echo "=== PKG Installation Completed Successfully ==="
echo "Your Python development environment is ready!"
echo "Open a new Terminal to start using conda."

exit 0