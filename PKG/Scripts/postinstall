#!/bin/bash  
# DTU Python Environment PKG - Postinstall Script
# Downloads and executes the orchestrator with PKG context

set -euo pipefail

# Set PKG environment context
export PIS_INSTALL_METHOD="PKG"
export PYTHON_VERSION_PS="3.11"
# Use current repository/branch for testing, fallback to main repo
export REMOTE_PS="${REMOTE_PS:-dtudk/pythonsupport-scripts}" 
export BRANCH_PS="${BRANCH_PS:-main}"

echo "=== DTU Python Environment PKG Installation ==="
echo "Installing Python development environment via PKG..."
echo ""

# Log to system log
logger -t "DTU-Python-PKG" "Starting DTU Python Environment installation"

# Execute the bundled orchestrator script
orchestrator_script="/usr/local/bin/dtu_orchestrator.sh"

echo "Executing bundled installation orchestrator..."
echo "Script: $orchestrator_script"
echo ""

if /bin/bash "$orchestrator_script"; then
    echo ""
    echo "=== PKG Installation Completed Successfully ==="
    echo "Your Python development environment is ready!"
    
    # Log success
    logger -t "DTU-Python-PKG" "DTU Python Environment installation completed successfully"
    
    # Show success dialog
    osascript -e 'display dialog "DTU Python Environment has been installed successfully! Your development environment is ready to use." with title "Installation Complete" buttons {"OK"} default button "OK" with icon note' &
    
    exit 0
else
    echo ""
    echo "=== PKG Installation Failed ==="
    echo "Please check the error messages above."
    
    # Log failure  
    logger -t "DTU-Python-PKG" "DTU Python Environment installation failed"
    
    # Show error dialog
    osascript -e 'display dialog "DTU Python Environment installation failed. Please check the system logs or try running the installation manually." with title "Installation Failed" buttons {"OK"} default button "OK" with icon stop' &
    
    exit 1
fi